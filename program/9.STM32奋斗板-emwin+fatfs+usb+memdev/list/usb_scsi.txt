; generated by Component: ARM Compiler 5.05 update 2 (build 169) Tool: ArmCC [4d0f38]
; commandline ArmCC [--list --debug -c --asm --interleave -o.\obj\usb_scsi.o --asm_dir=.\list\ --list_dir=.\list\ --depend=.\obj\usb_scsi.d --cpu=Cortex-M3 --apcs=interwork -O0 --diag_suppress=9931 -I.\FWlib\inc -I.\user -I.\CM3 -I.\MALLOC -I.\TFT -I.\EMWIN\EMWIN_INC -I.\EMWIN\DEMO -I.\PNG -I.\FATFS -I.\SDIO -I.\USB\inc -I.\USBCFG\inc -IE:\material\GUI\STM32·Ü¶·°å-emwin+fatfs+usb+memdev\RTE -Id:\Keil_v5\ARM\PACK\Keil\STM32F1xx_DFP\1.1.0\Device\Include -Id:\Keil_v5\ARM\CMSIS\Include -D__UVISION_VERSION=515 -DSTM32F10X_HD -DUSE_STDPERIPH_DRIVER -DSTM32F10X_HD -DUSE_STM3210B_EVAL --omf_browse=.\obj\usb_scsi.crf USBCFG\scr\usb_scsi.c]
                          THUMB

                          AREA ||.text||, CODE, READONLY, ALIGN=2

                  SCSI_Inquiry_Cmd PROC
;;;49     *******************************************************************************/
;;;50     void SCSI_Inquiry_Cmd(uint8_t lun)
000000  b570              PUSH     {r4-r6,lr}
;;;51     {
000002  4606              MOV      r6,r0
;;;52       uint8_t* Inquiry_Data;
;;;53       uint16_t Inquiry_Data_Length;
;;;54     
;;;55       if (CBW.CB[1] & 0x01)/*Evpd is set*/
000004  48f9              LDR      r0,|L1.1004|
000006  7c00              LDRB     r0,[r0,#0x10]
000008  f0000001          AND      r0,r0,#1
00000c  b110              CBZ      r0,|L1.20|
;;;56       {
;;;57         Inquiry_Data = Page00_Inquiry_Data;
00000e  4cf8              LDR      r4,|L1.1008|
;;;58         Inquiry_Data_Length = 5;
000010  2505              MOVS     r5,#5
000012  e00b              B        |L1.44|
                  |L1.20|
;;;59       }
;;;60       else
;;;61       {
;;;62     
;;;63         if ( lun == 0)
000014  b90e              CBNZ     r6,|L1.26|
;;;64         {
;;;65           Inquiry_Data = Standard_Inquiry_Data;
000016  4cf7              LDR      r4,|L1.1012|
000018  e000              B        |L1.28|
                  |L1.26|
;;;66         }
;;;67         else
;;;68         {
;;;69           Inquiry_Data = Standard_Inquiry_Data2;
00001a  4cf7              LDR      r4,|L1.1016|
                  |L1.28|
;;;70         }
;;;71     
;;;72         if (CBW.CB[4] <= STANDARD_INQUIRY_DATA_LEN)
00001c  48f3              LDR      r0,|L1.1004|
00001e  7cc0              LDRB     r0,[r0,#0x13]
000020  2824              CMP      r0,#0x24
000022  dc02              BGT      |L1.42|
;;;73           Inquiry_Data_Length = CBW.CB[4];
000024  48f1              LDR      r0,|L1.1004|
000026  7cc5              LDRB     r5,[r0,#0x13]
000028  e000              B        |L1.44|
                  |L1.42|
;;;74         else
;;;75           Inquiry_Data_Length = STANDARD_INQUIRY_DATA_LEN;
00002a  2524              MOVS     r5,#0x24
                  |L1.44|
;;;76     
;;;77       }
;;;78       Transfer_Data_Request(Inquiry_Data, Inquiry_Data_Length);
00002c  4629              MOV      r1,r5
00002e  4620              MOV      r0,r4
000030  f7fffffe          BL       Transfer_Data_Request
;;;79     }
000034  bd70              POP      {r4-r6,pc}
;;;80     
                          ENDP

                  Set_Scsi_Sense_Data PROC
;;;192    *******************************************************************************/
;;;193    void Set_Scsi_Sense_Data(uint8_t lun, uint8_t Sens_Key, uint8_t Asc)
000036  4bf1              LDR      r3,|L1.1020|
;;;194    {
;;;195      Scsi_Sense_Data[2] = Sens_Key;
000038  7099              STRB     r1,[r3,#2]
;;;196      Scsi_Sense_Data[12] = Asc;
00003a  731a              STRB     r2,[r3,#0xc]
;;;197    }
00003c  4770              BX       lr
;;;198    
                          ENDP

                  SCSI_ReadFormatCapacity_Cmd PROC
;;;87     *******************************************************************************/
;;;88     void SCSI_ReadFormatCapacity_Cmd(uint8_t lun)
00003e  b510              PUSH     {r4,lr}
;;;89     {
000040  4604              MOV      r4,r0
;;;90     
;;;91       if (MAL_GetStatus(lun) != 0 )
000042  4620              MOV      r0,r4
000044  f7fffffe          BL       MAL_GetStatus
000048  b168              CBZ      r0,|L1.102|
;;;92       {
;;;93         Set_Scsi_Sense_Data(CBW.bLUN, NOT_READY, MEDIUM_NOT_PRESENT);
00004a  49e8              LDR      r1,|L1.1004|
00004c  7b48              LDRB     r0,[r1,#0xd]  ; CBW
00004e  223a              MOVS     r2,#0x3a
000050  2102              MOVS     r1,#2
000052  f7fffffe          BL       Set_Scsi_Sense_Data
;;;94         Set_CSW (CSW_CMD_FAILED, SEND_CSW_ENABLE);
000056  2101              MOVS     r1,#1
000058  4608              MOV      r0,r1
00005a  f7fffffe          BL       Set_CSW
;;;95         Bot_Abort(DIR_IN);
00005e  2000              MOVS     r0,#0
000060  f7fffffe          BL       Bot_Abort
                  |L1.100|
;;;96         return;
;;;97       }
;;;98       ReadFormatCapacity_Data[4] = (uint8_t)(Mass_Block_Count[lun] >> 24);
;;;99       ReadFormatCapacity_Data[5] = (uint8_t)(Mass_Block_Count[lun] >> 16);
;;;100      ReadFormatCapacity_Data[6] = (uint8_t)(Mass_Block_Count[lun] >>  8);
;;;101      ReadFormatCapacity_Data[7] = (uint8_t)(Mass_Block_Count[lun]);
;;;102    
;;;103      ReadFormatCapacity_Data[9] = (uint8_t)(Mass_Block_Size[lun] >>  16);
;;;104      ReadFormatCapacity_Data[10] = (uint8_t)(Mass_Block_Size[lun] >>  8);
;;;105      ReadFormatCapacity_Data[11] = (uint8_t)(Mass_Block_Size[lun]);
;;;106      Transfer_Data_Request(ReadFormatCapacity_Data, READ_FORMAT_CAPACITY_DATA_LEN);
;;;107    }
000064  bd10              POP      {r4,pc}
                  |L1.102|
000066  48e6              LDR      r0,|L1.1024|
000068  f8500024          LDR      r0,[r0,r4,LSL #2]     ;98
00006c  0e00              LSRS     r0,r0,#24             ;98
00006e  49e5              LDR      r1,|L1.1028|
000070  7108              STRB     r0,[r1,#4]            ;98
000072  48e3              LDR      r0,|L1.1024|
000074  f8500024          LDR      r0,[r0,r4,LSL #2]     ;99
000078  0c00              LSRS     r0,r0,#16             ;99
00007a  7148              STRB     r0,[r1,#5]            ;99
00007c  48e0              LDR      r0,|L1.1024|
00007e  f8300024          LDRH     r0,[r0,r4,LSL #2]     ;100
000082  0a00              LSRS     r0,r0,#8              ;100
000084  7188              STRB     r0,[r1,#6]            ;100
000086  48de              LDR      r0,|L1.1024|
000088  f8100024          LDRB     r0,[r0,r4,LSL #2]     ;101
00008c  71c8              STRB     r0,[r1,#7]            ;101
00008e  48de              LDR      r0,|L1.1032|
000090  f8500024          LDR      r0,[r0,r4,LSL #2]     ;103
000094  0c00              LSRS     r0,r0,#16             ;103
000096  7248              STRB     r0,[r1,#9]            ;103
000098  48db              LDR      r0,|L1.1032|
00009a  f8300024          LDRH     r0,[r0,r4,LSL #2]     ;104
00009e  0a00              LSRS     r0,r0,#8              ;104
0000a0  7288              STRB     r0,[r1,#0xa]          ;104
0000a2  48d9              LDR      r0,|L1.1032|
0000a4  f8100024          LDRB     r0,[r0,r4,LSL #2]     ;105
0000a8  72c8              STRB     r0,[r1,#0xb]          ;105
0000aa  210c              MOVS     r1,#0xc               ;106
0000ac  48d5              LDR      r0,|L1.1028|
0000ae  f7fffffe          BL       Transfer_Data_Request
0000b2  bf00              NOP      
0000b4  e7d6              B        |L1.100|
;;;108    
                          ENDP

                  SCSI_ReadCapacity10_Cmd PROC
;;;115    *******************************************************************************/
;;;116    void SCSI_ReadCapacity10_Cmd(uint8_t lun)
0000b6  b510              PUSH     {r4,lr}
;;;117    {
0000b8  4604              MOV      r4,r0
;;;118    
;;;119      if (MAL_GetStatus(lun))
0000ba  4620              MOV      r0,r4
0000bc  f7fffffe          BL       MAL_GetStatus
0000c0  b168              CBZ      r0,|L1.222|
;;;120      {
;;;121        Set_Scsi_Sense_Data(CBW.bLUN, NOT_READY, MEDIUM_NOT_PRESENT);
0000c2  49ca              LDR      r1,|L1.1004|
0000c4  7b48              LDRB     r0,[r1,#0xd]  ; CBW
0000c6  223a              MOVS     r2,#0x3a
0000c8  2102              MOVS     r1,#2
0000ca  f7fffffe          BL       Set_Scsi_Sense_Data
;;;122        Set_CSW (CSW_CMD_FAILED, SEND_CSW_ENABLE);
0000ce  2101              MOVS     r1,#1
0000d0  4608              MOV      r0,r1
0000d2  f7fffffe          BL       Set_CSW
;;;123        Bot_Abort(DIR_IN);
0000d6  2000              MOVS     r0,#0
0000d8  f7fffffe          BL       Bot_Abort
                  |L1.220|
;;;124        return;
;;;125      }
;;;126    
;;;127      ReadCapacity10_Data[0] = (uint8_t)(Mass_Block_Count[lun] - 1 >> 24);
;;;128      ReadCapacity10_Data[1] = (uint8_t)(Mass_Block_Count[lun] - 1 >> 16);
;;;129      ReadCapacity10_Data[2] = (uint8_t)(Mass_Block_Count[lun] - 1 >>  8);
;;;130      ReadCapacity10_Data[3] = (uint8_t)(Mass_Block_Count[lun] - 1);
;;;131    
;;;132      ReadCapacity10_Data[4] = (uint8_t)(Mass_Block_Size[lun] >>  24);
;;;133      ReadCapacity10_Data[5] = (uint8_t)(Mass_Block_Size[lun] >>  16);
;;;134      ReadCapacity10_Data[6] = (uint8_t)(Mass_Block_Size[lun] >>  8);
;;;135      ReadCapacity10_Data[7] = (uint8_t)(Mass_Block_Size[lun]);
;;;136      Transfer_Data_Request(ReadCapacity10_Data, READ_CAPACITY10_DATA_LEN);
;;;137    }
0000dc  bd10              POP      {r4,pc}
                  |L1.222|
0000de  48c8              LDR      r0,|L1.1024|
0000e0  f8500024          LDR      r0,[r0,r4,LSL #2]     ;127
0000e4  1e40              SUBS     r0,r0,#1              ;127
0000e6  0e00              LSRS     r0,r0,#24             ;127
0000e8  49c8              LDR      r1,|L1.1036|
0000ea  7008              STRB     r0,[r1,#0]            ;127
0000ec  48c4              LDR      r0,|L1.1024|
0000ee  f8500024          LDR      r0,[r0,r4,LSL #2]     ;128
0000f2  1e40              SUBS     r0,r0,#1              ;128
0000f4  0c00              LSRS     r0,r0,#16             ;128
0000f6  7048              STRB     r0,[r1,#1]            ;128
0000f8  48c1              LDR      r0,|L1.1024|
0000fa  f8300024          LDRH     r0,[r0,r4,LSL #2]     ;129
0000fe  1e40              SUBS     r0,r0,#1              ;129
000100  0a00              LSRS     r0,r0,#8              ;129
000102  7088              STRB     r0,[r1,#2]            ;129
000104  48be              LDR      r0,|L1.1024|
000106  f8100024          LDRB     r0,[r0,r4,LSL #2]     ;130
00010a  1e40              SUBS     r0,r0,#1              ;130
00010c  70c8              STRB     r0,[r1,#3]            ;130
00010e  48be              LDR      r0,|L1.1032|
000110  f8500024          LDR      r0,[r0,r4,LSL #2]     ;132
000114  0e00              LSRS     r0,r0,#24             ;132
000116  7108              STRB     r0,[r1,#4]            ;132
000118  48bb              LDR      r0,|L1.1032|
00011a  f8500024          LDR      r0,[r0,r4,LSL #2]     ;133
00011e  0c00              LSRS     r0,r0,#16             ;133
000120  7148              STRB     r0,[r1,#5]            ;133
000122  48b9              LDR      r0,|L1.1032|
000124  f8300024          LDRH     r0,[r0,r4,LSL #2]     ;134
000128  0a00              LSRS     r0,r0,#8              ;134
00012a  7188              STRB     r0,[r1,#6]            ;134
00012c  48b6              LDR      r0,|L1.1032|
00012e  f8100024          LDRB     r0,[r0,r4,LSL #2]     ;135
000132  71c8              STRB     r0,[r1,#7]            ;135
000134  2108              MOVS     r1,#8                 ;136
000136  48b5              LDR      r0,|L1.1036|
000138  f7fffffe          BL       Transfer_Data_Request
00013c  bf00              NOP      
00013e  e7cd              B        |L1.220|
;;;138    
                          ENDP

                  SCSI_ModeSense6_Cmd PROC
;;;145    *******************************************************************************/
;;;146    void SCSI_ModeSense6_Cmd (uint8_t lun)
000140  b510              PUSH     {r4,lr}
;;;147    {
000142  4604              MOV      r4,r0
;;;148      Transfer_Data_Request(Mode_Sense6_data, MODE_SENSE6_DATA_LEN);
000144  2104              MOVS     r1,#4
000146  48b2              LDR      r0,|L1.1040|
000148  f7fffffe          BL       Transfer_Data_Request
;;;149    }
00014c  bd10              POP      {r4,pc}
;;;150    
                          ENDP

                  SCSI_ModeSense10_Cmd PROC
;;;157    *******************************************************************************/
;;;158    void SCSI_ModeSense10_Cmd (uint8_t lun)
00014e  b510              PUSH     {r4,lr}
;;;159    {
000150  4604              MOV      r4,r0
;;;160      Transfer_Data_Request(Mode_Sense10_data, MODE_SENSE10_DATA_LEN);
000152  2108              MOVS     r1,#8
000154  48af              LDR      r0,|L1.1044|
000156  f7fffffe          BL       Transfer_Data_Request
;;;161    }
00015a  bd10              POP      {r4,pc}
;;;162    
                          ENDP

                  SCSI_RequestSense_Cmd PROC
;;;169    *******************************************************************************/
;;;170    void SCSI_RequestSense_Cmd (uint8_t lun)
00015c  b570              PUSH     {r4-r6,lr}
;;;171    {
00015e  4605              MOV      r5,r0
;;;172      uint8_t Request_Sense_data_Length;
;;;173    
;;;174      if (CBW.CB[4] <= REQUEST_SENSE_DATA_LEN)
000160  48a2              LDR      r0,|L1.1004|
000162  7cc0              LDRB     r0,[r0,#0x13]
000164  2812              CMP      r0,#0x12
000166  dc02              BGT      |L1.366|
;;;175      {
;;;176        Request_Sense_data_Length = CBW.CB[4];
000168  48a0              LDR      r0,|L1.1004|
00016a  7cc4              LDRB     r4,[r0,#0x13]
00016c  e000              B        |L1.368|
                  |L1.366|
;;;177      }
;;;178      else
;;;179      {
;;;180        Request_Sense_data_Length = REQUEST_SENSE_DATA_LEN;
00016e  2412              MOVS     r4,#0x12
                  |L1.368|
;;;181      }
;;;182      Transfer_Data_Request(Scsi_Sense_Data, Request_Sense_data_Length);
000170  4621              MOV      r1,r4
000172  48a2              LDR      r0,|L1.1020|
000174  f7fffffe          BL       Transfer_Data_Request
;;;183    }
000178  bd70              POP      {r4-r6,pc}
;;;184    
                          ENDP

                  SCSI_Start_Stop_Unit_Cmd PROC
;;;205    *******************************************************************************/
;;;206    void SCSI_Start_Stop_Unit_Cmd(uint8_t lun)
00017a  b510              PUSH     {r4,lr}
;;;207    {
00017c  4604              MOV      r4,r0
;;;208      Set_CSW (CSW_CMD_PASSED, SEND_CSW_ENABLE);
00017e  2101              MOVS     r1,#1
000180  2000              MOVS     r0,#0
000182  f7fffffe          BL       Set_CSW
;;;209    }
000186  bd10              POP      {r4,pc}
;;;210    
                          ENDP

                  SCSI_Address_Management PROC
;;;402    *******************************************************************************/
;;;403    bool SCSI_Address_Management(uint8_t lun , uint8_t Cmd , uint32_t LBA , uint32_t BlockNbr)
000188  e92d41f0          PUSH     {r4-r8,lr}
;;;404    {
00018c  4604              MOV      r4,r0
00018e  460d              MOV      r5,r1
000190  4617              MOV      r7,r2
000192  461e              MOV      r6,r3
;;;405    
;;;406      if ((LBA + BlockNbr) > Mass_Block_Count[lun] )
000194  19b8              ADDS     r0,r7,r6
000196  499a              LDR      r1,|L1.1024|
000198  f8511024          LDR      r1,[r1,r4,LSL #2]
00019c  4288              CMP      r0,r1
00019e  d913              BLS      |L1.456|
;;;407      {
;;;408        if (Cmd == SCSI_WRITE10)
0001a0  2d2a              CMP      r5,#0x2a
0001a2  d102              BNE      |L1.426|
;;;409        {
;;;410          Bot_Abort(BOTH_DIR);
0001a4  2002              MOVS     r0,#2
0001a6  f7fffffe          BL       Bot_Abort
                  |L1.426|
;;;411        }
;;;412        Bot_Abort(DIR_IN);
0001aa  2000              MOVS     r0,#0
0001ac  f7fffffe          BL       Bot_Abort
;;;413        Set_Scsi_Sense_Data(lun, ILLEGAL_REQUEST, ADDRESS_OUT_OF_RANGE);
0001b0  2221              MOVS     r2,#0x21
0001b2  2105              MOVS     r1,#5
0001b4  4620              MOV      r0,r4
0001b6  f7fffffe          BL       Set_Scsi_Sense_Data
;;;414        Set_CSW (CSW_CMD_FAILED, SEND_CSW_DISABLE);
0001ba  2100              MOVS     r1,#0
0001bc  2001              MOVS     r0,#1
0001be  f7fffffe          BL       Set_CSW
;;;415        return (FALSE);
0001c2  2000              MOVS     r0,#0
                  |L1.452|
;;;416      }
;;;417    
;;;418    
;;;419      if (CBW.dDataLength != BlockNbr * Mass_Block_Size[lun])
;;;420      {
;;;421        if (Cmd == SCSI_WRITE10)
;;;422        {
;;;423          Bot_Abort(BOTH_DIR);
;;;424        }
;;;425        else
;;;426        {
;;;427          Bot_Abort(DIR_IN);
;;;428        }
;;;429        Set_Scsi_Sense_Data(CBW.bLUN, ILLEGAL_REQUEST, INVALID_FIELED_IN_COMMAND);
;;;430        Set_CSW (CSW_CMD_FAILED, SEND_CSW_DISABLE);
;;;431        return (FALSE);
;;;432      }
;;;433      return (TRUE);
;;;434    }
0001c4  e8bd81f0          POP      {r4-r8,pc}
                  |L1.456|
0001c8  4888              LDR      r0,|L1.1004|
0001ca  6881              LDR      r1,[r0,#8]            ;419  ; CBW
0001cc  488e              LDR      r0,|L1.1032|
0001ce  f8500024          LDR      r0,[r0,r4,LSL #2]     ;419
0001d2  4370              MULS     r0,r6,r0              ;419
0001d4  4281              CMP      r1,r0                 ;419
0001d6  d014              BEQ      |L1.514|
0001d8  2d2a              CMP      r5,#0x2a              ;421
0001da  d103              BNE      |L1.484|
0001dc  2002              MOVS     r0,#2                 ;423
0001de  f7fffffe          BL       Bot_Abort
0001e2  e002              B        |L1.490|
                  |L1.484|
0001e4  2000              MOVS     r0,#0                 ;427
0001e6  f7fffffe          BL       Bot_Abort
                  |L1.490|
0001ea  4980              LDR      r1,|L1.1004|
0001ec  7b48              LDRB     r0,[r1,#0xd]          ;429  ; CBW
0001ee  2224              MOVS     r2,#0x24              ;429
0001f0  2105              MOVS     r1,#5                 ;429
0001f2  f7fffffe          BL       Set_Scsi_Sense_Data
0001f6  2100              MOVS     r1,#0                 ;430
0001f8  2001              MOVS     r0,#1                 ;430
0001fa  f7fffffe          BL       Set_CSW
0001fe  2000              MOVS     r0,#0                 ;431
000200  e7e0              B        |L1.452|
                  |L1.514|
000202  2001              MOVS     r0,#1                 ;433
000204  e7de              B        |L1.452|
;;;435    /******************* (C) COPYRIGHT 2010 STMicroelectronics *****END OF FILE****/
                          ENDP

                  SCSI_Read10_Cmd PROC
;;;217    *******************************************************************************/
;;;218    void SCSI_Read10_Cmd(uint8_t lun , uint32_t LBA , uint32_t BlockNbr)
000206  b570              PUSH     {r4-r6,lr}
;;;219    {
000208  4606              MOV      r6,r0
00020a  460c              MOV      r4,r1
00020c  4615              MOV      r5,r2
;;;220    
;;;221      if (Bot_State == BOT_IDLE)
00020e  4882              LDR      r0,|L1.1048|
000210  7800              LDRB     r0,[r0,#0]  ; Bot_State
000212  bb20              CBNZ     r0,|L1.606|
;;;222      {
;;;223        if (!(SCSI_Address_Management(CBW.bLUN, SCSI_READ10, LBA, BlockNbr)))/*address out of range*/
000214  4975              LDR      r1,|L1.1004|
000216  7b48              LDRB     r0,[r1,#0xd]  ; CBW
000218  462b              MOV      r3,r5
00021a  4622              MOV      r2,r4
00021c  2128              MOVS     r1,#0x28
00021e  f7fffffe          BL       SCSI_Address_Management
000222  b900              CBNZ     r0,|L1.550|
                  |L1.548|
;;;224        {
;;;225          return;
;;;226        }
;;;227    
;;;228        if ((CBW.bmFlags & 0x80) != 0)
;;;229        {
;;;230          Bot_State = BOT_DATA_IN;
;;;231          Read_Memory(lun, LBA , BlockNbr);
;;;232        }
;;;233        else
;;;234        {
;;;235          Bot_Abort(BOTH_DIR);
;;;236          Set_Scsi_Sense_Data(CBW.bLUN, ILLEGAL_REQUEST, INVALID_FIELED_IN_COMMAND);
;;;237          Set_CSW (CSW_CMD_FAILED, SEND_CSW_ENABLE);
;;;238        }
;;;239        return;
;;;240      }
;;;241      else if (Bot_State == BOT_DATA_IN)
;;;242      {
;;;243        Read_Memory(lun , LBA , BlockNbr);
;;;244      }
;;;245    }
000224  bd70              POP      {r4-r6,pc}
                  |L1.550|
000226  4871              LDR      r0,|L1.1004|
000228  7b00              LDRB     r0,[r0,#0xc]          ;228  ; CBW
00022a  f0000080          AND      r0,r0,#0x80           ;228
00022e  b140              CBZ      r0,|L1.578|
000230  2002              MOVS     r0,#2                 ;230
000232  4979              LDR      r1,|L1.1048|
000234  7008              STRB     r0,[r1,#0]            ;230
000236  462a              MOV      r2,r5                 ;231
000238  4621              MOV      r1,r4                 ;231
00023a  4630              MOV      r0,r6                 ;231
00023c  f7fffffe          BL       Read_Memory
000240  e00c              B        |L1.604|
                  |L1.578|
000242  2002              MOVS     r0,#2                 ;235
000244  f7fffffe          BL       Bot_Abort
000248  4968              LDR      r1,|L1.1004|
00024a  7b48              LDRB     r0,[r1,#0xd]          ;236  ; CBW
00024c  2224              MOVS     r2,#0x24              ;236
00024e  2105              MOVS     r1,#5                 ;236
000250  f7fffffe          BL       Set_Scsi_Sense_Data
000254  2101              MOVS     r1,#1                 ;237
000256  4608              MOV      r0,r1                 ;237
000258  f7fffffe          BL       Set_CSW
                  |L1.604|
00025c  e7e2              B        |L1.548|
                  |L1.606|
00025e  486e              LDR      r0,|L1.1048|
000260  7800              LDRB     r0,[r0,#0]            ;241  ; Bot_State
000262  2802              CMP      r0,#2                 ;241
000264  d104              BNE      |L1.624|
000266  462a              MOV      r2,r5                 ;243
000268  4621              MOV      r1,r4                 ;243
00026a  4630              MOV      r0,r6                 ;243
00026c  f7fffffe          BL       Read_Memory
                  |L1.624|
000270  bf00              NOP      
000272  e7d7              B        |L1.548|
;;;246    
                          ENDP

                  SCSI_Write10_Cmd PROC
;;;253    *******************************************************************************/
;;;254    void SCSI_Write10_Cmd(uint8_t lun , uint32_t LBA , uint32_t BlockNbr)
000274  b570              PUSH     {r4-r6,lr}
;;;255    {
000276  4606              MOV      r6,r0
000278  460c              MOV      r4,r1
00027a  4615              MOV      r5,r2
;;;256    
;;;257      if (Bot_State == BOT_IDLE)
00027c  4866              LDR      r0,|L1.1048|
00027e  7800              LDRB     r0,[r0,#0]  ; Bot_State
000280  bb20              CBNZ     r0,|L1.716|
;;;258      {
;;;259        if (!(SCSI_Address_Management(CBW.bLUN, SCSI_WRITE10 , LBA, BlockNbr)))/*address out of range*/
000282  495a              LDR      r1,|L1.1004|
000284  7b48              LDRB     r0,[r1,#0xd]  ; CBW
000286  462b              MOV      r3,r5
000288  4622              MOV      r2,r4
00028a  212a              MOVS     r1,#0x2a
00028c  f7fffffe          BL       SCSI_Address_Management
000290  b900              CBNZ     r0,|L1.660|
                  |L1.658|
;;;260        {
;;;261          return;
;;;262        }
;;;263    
;;;264        if ((CBW.bmFlags & 0x80) == 0)
;;;265        {
;;;266          Bot_State = BOT_DATA_OUT;
;;;267        #ifndef STM32F10X_CL
;;;268          SetEPRxStatus(ENDP2, EP_RX_VALID);
;;;269        #endif /* STM32F10X_CL */
;;;270        }
;;;271        else
;;;272        {
;;;273          Bot_Abort(DIR_IN);
;;;274          Set_Scsi_Sense_Data(CBW.bLUN, ILLEGAL_REQUEST, INVALID_FIELED_IN_COMMAND);
;;;275          Set_CSW (CSW_CMD_FAILED, SEND_CSW_DISABLE);
;;;276        }
;;;277        return;
;;;278      }
;;;279      else if (Bot_State == BOT_DATA_OUT)
;;;280      {
;;;281        Write_Memory(lun , LBA , BlockNbr);
;;;282      }
;;;283    }
000292  bd70              POP      {r4-r6,pc}
                  |L1.660|
000294  4855              LDR      r0,|L1.1004|
000296  7b00              LDRB     r0,[r0,#0xc]          ;264  ; CBW
000298  f0000080          AND      r0,r0,#0x80           ;264
00029c  b940              CBNZ     r0,|L1.688|
00029e  2001              MOVS     r0,#1                 ;266
0002a0  495d              LDR      r1,|L1.1048|
0002a2  7008              STRB     r0,[r1,#0]            ;266
0002a4  f44f5140          MOV      r1,#0x3000            ;268
0002a8  2002              MOVS     r0,#2                 ;268
0002aa  f7fffffe          BL       SetEPRxStatus
0002ae  e00c              B        |L1.714|
                  |L1.688|
0002b0  2000              MOVS     r0,#0                 ;273
0002b2  f7fffffe          BL       Bot_Abort
0002b6  494d              LDR      r1,|L1.1004|
0002b8  7b48              LDRB     r0,[r1,#0xd]          ;274  ; CBW
0002ba  2224              MOVS     r2,#0x24              ;274
0002bc  2105              MOVS     r1,#5                 ;274
0002be  f7fffffe          BL       Set_Scsi_Sense_Data
0002c2  2100              MOVS     r1,#0                 ;275
0002c4  2001              MOVS     r0,#1                 ;275
0002c6  f7fffffe          BL       Set_CSW
                  |L1.714|
0002ca  e7e2              B        |L1.658|
                  |L1.716|
0002cc  4852              LDR      r0,|L1.1048|
0002ce  7800              LDRB     r0,[r0,#0]            ;279  ; Bot_State
0002d0  2801              CMP      r0,#1                 ;279
0002d2  d104              BNE      |L1.734|
0002d4  462a              MOV      r2,r5                 ;281
0002d6  4621              MOV      r1,r4                 ;281
0002d8  4630              MOV      r0,r6                 ;281
0002da  f7fffffe          BL       Write_Memory
                  |L1.734|
0002de  bf00              NOP      
0002e0  e7d7              B        |L1.658|
;;;284    
                          ENDP

                  SCSI_Verify10_Cmd PROC
;;;291    *******************************************************************************/
;;;292    void SCSI_Verify10_Cmd(uint8_t lun)
0002e2  b510              PUSH     {r4,lr}
;;;293    {
0002e4  4604              MOV      r4,r0
;;;294      if ((CBW.dDataLength == 0) && !(CBW.CB[1] & BLKVFY))/* BLKVFY not set*/
0002e6  4841              LDR      r0,|L1.1004|
0002e8  6880              LDR      r0,[r0,#8]  ; CBW
0002ea  b948              CBNZ     r0,|L1.768|
0002ec  483f              LDR      r0,|L1.1004|
0002ee  7c00              LDRB     r0,[r0,#0x10]
0002f0  f0000004          AND      r0,r0,#4
0002f4  b920              CBNZ     r0,|L1.768|
;;;295      {
;;;296        Set_CSW (CSW_CMD_PASSED, SEND_CSW_ENABLE);
0002f6  2101              MOVS     r1,#1
0002f8  2000              MOVS     r0,#0
0002fa  f7fffffe          BL       Set_CSW
0002fe  e00c              B        |L1.794|
                  |L1.768|
;;;297      }
;;;298      else
;;;299      {
;;;300        Bot_Abort(BOTH_DIR);
000300  2002              MOVS     r0,#2
000302  f7fffffe          BL       Bot_Abort
;;;301        Set_Scsi_Sense_Data(CBW.bLUN, ILLEGAL_REQUEST, INVALID_FIELED_IN_COMMAND);
000306  4939              LDR      r1,|L1.1004|
000308  7b48              LDRB     r0,[r1,#0xd]  ; CBW
00030a  2224              MOVS     r2,#0x24
00030c  2105              MOVS     r1,#5
00030e  f7fffffe          BL       Set_Scsi_Sense_Data
;;;302        Set_CSW (CSW_CMD_FAILED, SEND_CSW_DISABLE);
000312  2100              MOVS     r1,#0
000314  2001              MOVS     r0,#1
000316  f7fffffe          BL       Set_CSW
                  |L1.794|
;;;303      }
;;;304    }
00031a  bd10              POP      {r4,pc}
;;;305    /*******************************************************************************
                          ENDP

                  SCSI_Valid_Cmd PROC
;;;311    *******************************************************************************/
;;;312    void SCSI_Valid_Cmd(uint8_t lun)
00031c  b510              PUSH     {r4,lr}
;;;313    {
00031e  4604              MOV      r4,r0
;;;314      if (CBW.dDataLength != 0)
000320  4832              LDR      r0,|L1.1004|
000322  6880              LDR      r0,[r0,#8]  ; CBW
000324  b168              CBZ      r0,|L1.834|
;;;315      {
;;;316        Bot_Abort(BOTH_DIR);
000326  2002              MOVS     r0,#2
000328  f7fffffe          BL       Bot_Abort
;;;317        Set_Scsi_Sense_Data(CBW.bLUN, ILLEGAL_REQUEST, INVALID_COMMAND);
00032c  492f              LDR      r1,|L1.1004|
00032e  7b48              LDRB     r0,[r1,#0xd]  ; CBW
000330  2220              MOVS     r2,#0x20
000332  2105              MOVS     r1,#5
000334  f7fffffe          BL       Set_Scsi_Sense_Data
;;;318        Set_CSW (CSW_CMD_FAILED, SEND_CSW_DISABLE);
000338  2100              MOVS     r1,#0
00033a  2001              MOVS     r0,#1
00033c  f7fffffe          BL       Set_CSW
000340  e003              B        |L1.842|
                  |L1.834|
;;;319      }
;;;320      else
;;;321        Set_CSW (CSW_CMD_PASSED, SEND_CSW_ENABLE);
000342  2101              MOVS     r1,#1
000344  2000              MOVS     r0,#0
000346  f7fffffe          BL       Set_CSW
                  |L1.842|
;;;322    }
00034a  bd10              POP      {r4,pc}
;;;323    /*******************************************************************************
                          ENDP

                  SCSI_TestUnitReady_Cmd PROC
;;;329    *******************************************************************************/
;;;330    void SCSI_TestUnitReady_Cmd(uint8_t lun)
00034c  b510              PUSH     {r4,lr}
;;;331    {
00034e  4604              MOV      r4,r0
;;;332      if (MAL_GetStatus(lun))
000350  4620              MOV      r0,r4
000352  f7fffffe          BL       MAL_GetStatus
000356  b168              CBZ      r0,|L1.884|
;;;333      {
;;;334        Set_Scsi_Sense_Data(CBW.bLUN, NOT_READY, MEDIUM_NOT_PRESENT);
000358  4924              LDR      r1,|L1.1004|
00035a  7b48              LDRB     r0,[r1,#0xd]  ; CBW
00035c  223a              MOVS     r2,#0x3a
00035e  2102              MOVS     r1,#2
000360  f7fffffe          BL       Set_Scsi_Sense_Data
;;;335        Set_CSW (CSW_CMD_FAILED, SEND_CSW_ENABLE);
000364  2101              MOVS     r1,#1
000366  4608              MOV      r0,r1
000368  f7fffffe          BL       Set_CSW
;;;336        Bot_Abort(DIR_IN);
00036c  2000              MOVS     r0,#0
00036e  f7fffffe          BL       Bot_Abort
                  |L1.882|
;;;337        return;
;;;338      }
;;;339      else
;;;340      {
;;;341        Set_CSW (CSW_CMD_PASSED, SEND_CSW_ENABLE);
;;;342      }
;;;343    }
000372  bd10              POP      {r4,pc}
                  |L1.884|
000374  2101              MOVS     r1,#1                 ;341
000376  2000              MOVS     r0,#0                 ;341
000378  f7fffffe          BL       Set_CSW
00037c  bf00              NOP      
00037e  e7f8              B        |L1.882|
;;;344    /*******************************************************************************
                          ENDP

                  SCSI_Format_Cmd PROC
;;;350    *******************************************************************************/
;;;351    void SCSI_Format_Cmd(uint8_t lun)
000380  b510              PUSH     {r4,lr}
;;;352    {
000382  4604              MOV      r4,r0
;;;353      if (MAL_GetStatus(lun))
000384  4620              MOV      r0,r4
000386  f7fffffe          BL       MAL_GetStatus
00038a  b168              CBZ      r0,|L1.936|
;;;354      {
;;;355        Set_Scsi_Sense_Data(CBW.bLUN, NOT_READY, MEDIUM_NOT_PRESENT);
00038c  4917              LDR      r1,|L1.1004|
00038e  7b48              LDRB     r0,[r1,#0xd]  ; CBW
000390  223a              MOVS     r2,#0x3a
000392  2102              MOVS     r1,#2
000394  f7fffffe          BL       Set_Scsi_Sense_Data
;;;356        Set_CSW (CSW_CMD_FAILED, SEND_CSW_ENABLE);
000398  2101              MOVS     r1,#1
00039a  4608              MOV      r0,r1
00039c  f7fffffe          BL       Set_CSW
;;;357        Bot_Abort(DIR_IN);
0003a0  2000              MOVS     r0,#0
0003a2  f7fffffe          BL       Bot_Abort
                  |L1.934|
;;;358        return;
;;;359      }
;;;360    #ifdef USE_STM3210E_EVAL
;;;361      else
;;;362      {
;;;363        //NAND_Format();
;;;364        //Set_CSW (CSW_CMD_PASSED, SEND_CSW_ENABLE);
;;;365      }
;;;366    #endif
;;;367    }
0003a6  bd10              POP      {r4,pc}
                  |L1.936|
0003a8  bf00              NOP      
0003aa  e7fc              B        |L1.934|
;;;368    /*******************************************************************************
                          ENDP

                  SCSI_Invalid_Cmd PROC
;;;374    *******************************************************************************/
;;;375    void SCSI_Invalid_Cmd(uint8_t lun)
0003ac  b510              PUSH     {r4,lr}
;;;376    {
0003ae  4604              MOV      r4,r0
;;;377      if (CBW.dDataLength == 0)
0003b0  480e              LDR      r0,|L1.1004|
0003b2  6880              LDR      r0,[r0,#8]  ; CBW
0003b4  b918              CBNZ     r0,|L1.958|
;;;378      {
;;;379        Bot_Abort(DIR_IN);
0003b6  2000              MOVS     r0,#0
0003b8  f7fffffe          BL       Bot_Abort
0003bc  e00b              B        |L1.982|
                  |L1.958|
;;;380      }
;;;381      else
;;;382      {
;;;383        if ((CBW.bmFlags & 0x80) != 0)
0003be  480b              LDR      r0,|L1.1004|
0003c0  7b00              LDRB     r0,[r0,#0xc]  ; CBW
0003c2  f0000080          AND      r0,r0,#0x80
0003c6  b118              CBZ      r0,|L1.976|
;;;384        {
;;;385          Bot_Abort(DIR_IN);
0003c8  2000              MOVS     r0,#0
0003ca  f7fffffe          BL       Bot_Abort
0003ce  e002              B        |L1.982|
                  |L1.976|
;;;386        }
;;;387        else
;;;388        {
;;;389          Bot_Abort(BOTH_DIR);
0003d0  2002              MOVS     r0,#2
0003d2  f7fffffe          BL       Bot_Abort
                  |L1.982|
;;;390        }
;;;391      }
;;;392      Set_Scsi_Sense_Data(CBW.bLUN, ILLEGAL_REQUEST, INVALID_COMMAND);
0003d6  4905              LDR      r1,|L1.1004|
0003d8  7b48              LDRB     r0,[r1,#0xd]  ; CBW
0003da  2220              MOVS     r2,#0x20
0003dc  2105              MOVS     r1,#5
0003de  f7fffffe          BL       Set_Scsi_Sense_Data
;;;393      Set_CSW (CSW_CMD_FAILED, SEND_CSW_DISABLE);
0003e2  2100              MOVS     r1,#0
0003e4  2001              MOVS     r0,#1
0003e6  f7fffffe          BL       Set_CSW
;;;394    }
0003ea  bd10              POP      {r4,pc}
                  |L1.1004|
                          DCD      ||CBW||
                  |L1.1008|
                          DCD      Page00_Inquiry_Data
                  |L1.1012|
                          DCD      Standard_Inquiry_Data
                  |L1.1016|
                          DCD      Standard_Inquiry_Data2
                  |L1.1020|
                          DCD      Scsi_Sense_Data
                  |L1.1024|
                          DCD      Mass_Block_Count
                  |L1.1028|
                          DCD      ReadFormatCapacity_Data
                  |L1.1032|
                          DCD      Mass_Block_Size
                  |L1.1036|
                          DCD      ReadCapacity10_Data
                  |L1.1040|
                          DCD      Mode_Sense6_data
                  |L1.1044|
                          DCD      Mode_Sense10_data
                  |L1.1048|
                          DCD      Bot_State
                          ENDP

